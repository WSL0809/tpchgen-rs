name: TPC-DS Conformance

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Conformance testing against Java implementation
  conformance-tests:
    name: Conformance Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Set up Java
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Cache Rust dependencies
      uses: actions/cache@v5
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Bootstrap Java TPC-DS implementation
      run: |
        cd tpcdsgen
        ./scripts/bootstrap-java.sh

    - name: Build Rust table generators
      run: |
        cargo build --release -p tpcdsgen

    - name: Generate test fixtures (Java reference data)
      run: |
        cd tpcdsgen
        ./scripts/generate-fixtures.sh

    - name: Run conformance tests (Rust vs Java)
      run: |
        cd tpcdsgen
        ./scripts/test-all-tables.sh

    - name: Upload test fixtures as artifacts
      if: failure()  # Upload fixtures if tests fail for debugging
      uses: actions/upload-artifact@v6
      with:
        name: test-fixtures
        path: tpcdsgen/tests/fixtures/
        retention-days: 7

  # Performance benchmarks (optional - only on main)
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    needs: conformance-tests

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Rust dependencies
      uses: actions/cache@v5
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Build release binaries
      run: |
        cargo build --release -p tpcdsgen

    - name: Run benchmarks
      run: |
        # Generate all tables and time it using the unified CLI
        mkdir -p /tmp/bench
        time ./target/release/tpcdsgen --scale 1 --directory /tmp/bench

    - name: Upload benchmark results
      uses: actions/upload-artifact@v6
      with:
        name: benchmark-results
        path: /tmp/bench/
        retention-days: 30
